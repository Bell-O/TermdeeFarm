{% extends "base.html" %}

{% block title %}เปลี่ยนรหัสผ่าน - Termdee Farm{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">เปลี่ยนรหัสผ่านแอดมิน</h1>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">กลับ</a>
    </div>

    <div class="mt-3">
        <form id="changePasswordForm" onsubmit="changePassword(event)">
            <div class="form-group">
                <label class="form-label">รหัสผ่านปัจจุบัน</label>
                <input type="password" name="current_password" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">รหัสผ่านใหม่</label>
                <input type="password" name="new_password" class="form-control" required minlength="4">
                <small style="color: var(--text-secondary);">รหัสผ่านต้องมีอย่างน้อย 4 ตัวอักษร</small>
            </div>
            <div class="form-group">
                <label class="form-label">ยืนยันรหัสผ่านใหม่</label>
                <input type="password" name="confirm_password" class="form-control" required minlength="4">
            </div>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">เปลี่ยนรหัสผ่าน</button>
                <button type="button" class="btn btn-secondary" onclick="history.back()">ยกเลิก</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function changePassword(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    
    const currentPassword = formData.get('current_password');
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        alert('รหัสผ่านใหม่ไม่ตรงกัน');
        return;
    }
    
    if (newPassword.length < 4) {
        alert('รหัสผ่านต้องมีอย่างน้อย 4 ตัวอักษร');
        return;
    }
    
    const csrfToken = getCsrfToken();
    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
    
    fetch('/api/admin/change_password', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            csrf_token: csrfToken
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('เปลี่ยนรหัสผ่านสำเร็จ!');
            window.location.href = '{{ url_for("admin_dashboard") }}';
        } else {
            alert(data.error || 'เกิดข้อผิดพลาด');
        }
    })
    .catch(err => {
        console.error(err);
        alert('เกิดข้อผิดพลาดในการเปลี่ยนรหัสผ่าน');
    });
}
</script>
{% endblock %}



