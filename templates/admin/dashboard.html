{% extends "base.html" %}

{% block title %}แดชบอร์ด - Termdee Farm{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">แดชบอร์ด</h1>
        <div class="btn-group">
            <button class="btn btn-success" onclick="exportPayments()">
                <i class="fas fa-download"></i> Export รายงานการจ่ายเงิน
            </button>
            <button id="toggleRefreshBtn" class="btn btn-warning" onclick="toggleAutoRefresh()">
                <i class="fas fa-pause"></i> หยุด Auto-Refresh
            </button>
            <span id="lastUpdate" style="color: var(--text-secondary); font-size: 0.875rem; margin-left: 1rem;"></span>
        </div>
    </div>

    <div class="grid grid-4 mt-3">
        <div class="card">
            <h3>ออเดอร์ทั้งหมด</h3>
            <p style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">{{ orders|length }}</p>
        </div>
        <div class="card">
            <h3>คนฟาร์ม</h3>
            <p style="font-size: 2rem; font-weight: bold; color: var(--success-color);">{{ farmers|length }}</p>
        </div>
        <div class="card">
            <h3>ออเดอร์ล่าสุด</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary);">
                {% if orders %}
                    {{ orders[0].order_key }}
                {% else %}
                    ยังไม่มี
                {% endif %}
            </p>
        </div>
        <div class="card">
            <a href="{{ url_for('admin_orders') }}" class="btn btn-primary">จัดการออเดอร์</a>
        </div>
    </div>

    <!-- สถิติรายได้ -->
    <div class="grid grid-3 mt-3">
        <div class="card">
            <h3>รายได้เดือนนี้</h3>
            <p style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                {{ "%.2f"|format(total_revenue) }} บาท
            </p>
            <small style="color: var(--text-secondary);">
                จ่ายให้คนฟาร์ม: {{ "%.2f"|format(total_paid_to_farmers) }} บาท<br>
                ค่าคนกลาง: {{ "%.2f"|format(total_commission) }} บาท
            </small>
        </div>
        <div class="card">
            <h3>รายได้สัปดาห์นี้</h3>
            <p style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">
                {{ "%.2f"|format(week_revenue) }} บาท
            </p>
            <small style="color: var(--text-secondary);">
                จ่ายให้คนฟาร์ม: {{ "%.2f"|format(week_paid) }} บาท
            </small>
        </div>
        <div class="card">
            <h3>ออเดอร์ที่เสร็จแล้ว</h3>
            <p style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">
                {{ completed_orders }}
            </p>
            <small style="color: var(--text-secondary);">
                กำลังทำ: {{ active_orders }} ออเดอร์
            </small>
        </div>
    </div>

    <!-- สถิติตามประเภทของ -->
    {% if item_stats %}
    <div class="card mt-3">
        <h2>สถิติตามประเภทของ</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ประเภท</th>
                        <th class="text-right">จำนวนงาน</th>
                        <th class="text-right">จำนวนรวม</th>
                        <th class="text-right">รายได้รวม</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_type, stats in item_stats.items() %}
                    <tr>
                        <td data-label="ประเภท"><span class="item-{{ item_type }}">{{ item_type|upper }}</span></td>
                        <td data-label="จำนวนงาน" class="text-right number">{{ "{:,}".format(stats.count) }}</td>
                        <td data-label="จำนวนรวม" class="text-right number">{{ "{:,}".format(stats.amount|int) }}</td>
                        <td data-label="รายได้รวม" class="text-right number"><strong>{{ "{:,.2f}".format(stats.revenue) }} บาท</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="mt-3">
        <h2>ออเดอร์ล่าสุด</h2>
        {% if orders %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Order Key</th>
                        <th>ลูกค้า</th>
                        <th>เซิร์ฟเวอร์</th>
                        <th>ประเภท</th>
                        <th class="text-center">สถานะ</th>
                        <th class="text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders[:10] %}
                    <tr>
                        <td data-label="Order Key"><strong>{{ order.order_key }}</strong></td>
                        <td data-label="ลูกค้า">{{ order.customer_ref or '-' }}</td>
                        <td data-label="เซิร์ฟเวอร์">{{ order.server_name or '-' }}</td>
                        <td data-label="ประเภท"><span class="item-{{ order.item_type }}">{{ order.item_type|upper }}</span></td>
                        <td data-label="สถานะ" class="text-center"><span class="badge badge-{{ order.status }}">{{ get_status_th(order.status) }}</span></td>
                        <td data-label="จัดการ" class="text-center">
                            <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" class="btn btn-sm btn-primary">ดู</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>ยังไม่มีออเดอร์</p>
        {% endif %}
    </div>
</div>

<script>
// Auto-refresh ทุก 60 วินาที (1 นาที)
let refreshInterval = null;
let autoRefreshEnabled = localStorage.getItem('autoRefresh') !== 'false';

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    if (autoRefreshEnabled) {
        refreshInterval = setInterval(() => {
            location.reload();
        }, 60000); // 60 วินาที
    }
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    localStorage.setItem('autoRefresh', autoRefreshEnabled);
    startAutoRefresh();
    const btn = document.getElementById('toggleRefreshBtn');
    if (btn) {
        btn.innerHTML = autoRefreshEnabled 
            ? '<i class="fas fa-pause"></i> หยุด Auto-Refresh' 
            : '<i class="fas fa-play"></i> เปิด Auto-Refresh';
        btn.className = autoRefreshEnabled ? 'btn btn-warning' : 'btn btn-success';
    }
}

// อัพเดตเวลาล่าสุด
function updateLastUpdateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH');
    const el = document.getElementById('lastUpdate');
    if (el) {
        el.textContent = `อัพเดตล่าสุด: ${timeStr}`;
    }
}

updateLastUpdateTime();
setInterval(updateLastUpdateTime, 1000);
startAutoRefresh();

function exportPayments() {
    const dateFrom = prompt('วันที่เริ่มต้น (YYYY-MM-DD) หรือกด Cancel สำหรับทั้งหมด:');
    const dateTo = prompt('วันที่สิ้นสุด (YYYY-MM-DD) หรือกด Cancel สำหรับทั้งหมด:');
    
    let url = '/api/admin/export/payments';
    const params = new URLSearchParams();
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    if (params.toString()) url += '?' + params.toString();
    
    window.location.href = url;
}
</script>
{% endblock %}

