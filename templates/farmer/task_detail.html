{% extends "base.html" %}

{% block title %}รายละเอียดงาน - Termdee Farm{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">รายละเอียดงาน</h1>
        <div class="btn-group">
            <a href="{{ url_for('farmer_tasks') }}" class="btn btn-secondary">กลับ</a>
            <button id="toggleRefreshBtn" class="btn btn-warning" onclick="toggleAutoRefresh()">
                <i class="fas fa-pause"></i> หยุด Auto-Refresh
            </button>
        </div>
    </div>

    <div class="grid grid-2 mt-3">
        <div>
            <h3>ข้อมูลงาน</h3>
            <p><strong>Order Key:</strong> {{ order.order_key }}</p>
            <p><strong>เซิร์ฟเวอร์:</strong> {{ task.server_name or '-' }}</p>
            <p><strong>ประเภทของ:</strong> <span class="item-{{ task.item_type }}">{{ task.item_type|upper }}</span></p>
            <p><strong>สถานะ:</strong> <span class="badge badge-{{ task.status }}">{{ get_status_th(task.status) }}</span></p>
            {% if task.planned_start %}
            <p><strong>เวลาเริ่มงาน:</strong> {{ task.planned_start.strftime('%d/%m/%Y %H:%M') }}</p>
            {% endif %}
            {% if task.planned_duration_hours %}
            <p><strong>เวลาที่คาดว่าจะใช้:</strong> 
                {% if task.planned_duration_hours >= 1 %}
                    {{ "%.1f"|format(task.planned_duration_hours) }} ชั่วโมง
                {% else %}
                    {{ (task.planned_duration_hours * 60)|int }} นาที
                {% endif %}
            </p>
            {% endif %}
            {% if task.current_amount > 0 %}
            {% set settings_data = Settings.get_settings() %}
            {% set commission = settings_data.get('commission_percent', 10.0) %}
            {% set price_before = Settings.calculate_price_before_commission(task.item_type, task.current_amount, order.discount_percent or 0) %}
            {% set price_after = Settings.calculate_price(task.item_type, task.current_amount, order.discount_percent or 0) %}
            <p><strong>เงินที่จะได้ (ปัจจุบัน):</strong></p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                <li>ก่อนหักค่าคนกลาง: <strong>{{ "%.2f"|format(price_before) }} บาท</strong></li>
                <li>หลังหักค่าคนกลาง {{ commission }}%: 
                    <span style="color: var(--success-color); font-size: 1.2rem; font-weight: bold;">
                        {{ "%.2f"|format(price_after) }} บาท
                    </span>
                </li>
            </ul>
            {% endif %}
            {% if task.target_amount > 0 %}
            {% set settings_data = Settings.get_settings() %}
            {% set commission = settings_data.get('commission_percent', 10.0) %}
            {% set price_before_final = Settings.calculate_price_before_commission(task.item_type, task.target_amount, order.discount_percent or 0) %}
            {% set price_after_final = Settings.calculate_price(task.item_type, task.target_amount, order.discount_percent or 0) %}
            <p><strong>เงินเมื่อเสร็จ:</strong></p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                <li>ก่อนหักค่าคนกลาง: <strong>{{ "%.2f"|format(price_before_final) }} บาท</strong></li>
                <li>หลังหักค่าคนกลาง {{ commission }}%: 
                    <span style="color: var(--primary-color); font-size: 1.1rem; font-weight: bold;">
                        {{ "%.2f"|format(price_after_final) }} บาท
                    </span>
                </li>
            </ul>
            {% if order.discount_percent and order.discount_percent > 0 %}
            <p><small style="color: var(--text-secondary);">
                <i class="fas fa-exclamation-triangle"></i> มีส่วนลด {{ order.discount_percent }}% ให้ลูกค้า
            </small></p>
            {% endif %}
            {% endif %}
        </div>
        <div>
            <h3>ความคืบหน้า</h3>
            <div class="progress">
                <div class="progress-bar {% if task.current_amount >= task.target_amount %}progress-bar-success{% endif %}" 
                     style="width: {{ (task.current_amount / task.target_amount * 100) if task.target_amount > 0 else 0 }}%">
                    {{ task.current_amount|int }} / {{ task.target_amount|int }}
                </div>
            </div>
            <p class="text-center mt-1">
                <strong>{{ ((task.current_amount / task.target_amount * 100) if task.target_amount > 0 else 0)|int }}%</strong>
            </p>
        </div>
    </div>

    <div class="mt-3">
        <h3>จัดการงาน</h3>
        
        {% if task.status == 'assigned' %}
            {% if task.farmer_id is none %}
                <button class="btn btn-success" onclick="selfAssignTask({{ task.id }})">รับงาน</button>
            {% elif task.farmer_id == current_user.id %}
                <button class="btn btn-success" onclick="acceptTask({{ task.id }})">ยืนยันรับงาน</button>
            {% else %}
                <p class="alert alert-warning">งานนี้ถูก assign ให้คนฟาร์มคนอื่นแล้ว</p>
            {% endif %}
        {% elif task.status == 'accepted' or task.status == 'paused' %}
        <button class="btn btn-primary" onclick="startTask({{ task.id }})">เริ่มฟาร์ม</button>
        {% endif %}

        {% if task.status == 'farming' %}
        <div class="mt-3">
            <h4>อัปเดตความคืบหน้า</h4>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="updateProgress({{ task.id }}, 1000)">+1,000</button>
                <button class="btn btn-primary" onclick="updateProgress({{ task.id }}, 5000)">+5,000</button>
                <button class="btn btn-primary" onclick="updateProgress({{ task.id }}, 10000)">+10,000</button>
            </div>
            <div class="btn-group mt-2">
                <button class="btn btn-danger" onclick="updateProgress({{ task.id }}, -1000)">-1,000</button>
                <button class="btn btn-danger" onclick="updateProgress({{ task.id }}, -5000)">-5,000</button>
                <button class="btn btn-danger" onclick="updateProgress({{ task.id }}, -10000)">-10,000</button>
            </div>
            <div class="form-group mt-2" style="max-width: 300px;">
                <input type="number" id="custom_amount" class="form-control" placeholder="จำนวนที่ต้องการเพิ่ม/ลด (ใช้ - สำหรับลด)">
                <button class="btn btn-primary mt-2" onclick="addCustomProgress({{ task.id }})">อัปเดตจำนวนที่กำหนด</button>
            </div>
            <div class="btn-group mt-2">
                <button class="btn btn-warning" onclick="pauseTask({{ task.id }})">พักงาน</button>
                {% if task.current_amount >= task.target_amount %}
                <button class="btn btn-success" onclick="readyTask({{ task.id }})">พร้อมส่ง</button>
                {% endif %}
            </div>
        </div>
        {% elif task.status == 'paused' %}
        <button class="btn btn-primary" onclick="startTask({{ task.id }})">เริ่มฟาร์มต่อ</button>
        {% elif task.status == 'ready_to_deliver' %}
        <button class="btn btn-success" onclick="deliveredTask({{ task.id }})">ส่งของแล้ว</button>
        {% endif %}
    </div>

    {% if task.note_farmer %}
    <div class="alert alert-info mt-3">
        <strong>หมายเหตุ:</strong> {{ task.note_farmer }}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh ทุก 60 วินาที (1 นาที)
let refreshInterval = null;
let autoRefreshEnabled = localStorage.getItem('autoRefresh') !== 'false';

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    if (autoRefreshEnabled) {
        refreshInterval = setInterval(() => {
            location.reload();
        }, 60000); // 60 วินาที
    }
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    localStorage.setItem('autoRefresh', autoRefreshEnabled);
    startAutoRefresh();
    const btn = document.getElementById('toggleRefreshBtn');
    if (btn) {
        btn.innerHTML = autoRefreshEnabled 
            ? '<i class="fas fa-pause"></i> หยุด Auto-Refresh' 
            : '<i class="fas fa-play"></i> เปิด Auto-Refresh';
        btn.className = autoRefreshEnabled ? 'btn btn-warning' : 'btn btn-success';
    }
}

startAutoRefresh();

function acceptTask(taskId) {
    const csrfToken = getCsrfToken();
    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
    
    fetch(`/api/farmer/task/${taskId}/accept`, { 
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ csrf_token: csrfToken })
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'เกิดข้อผิดพลาด');
            }
        });
}

function selfAssignTask(taskId) {
    if (!confirm('คุณต้องการรับงานนี้หรือไม่?')) {
        return;
    }
    
    const csrfToken = getCsrfToken();
    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
    
    fetch(`/api/farmer/task/${taskId}/self-assign`, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ csrf_token: csrfToken })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('รับงานสำเร็จ!');
            location.reload();
        } else {
            alert(data.error || 'เกิดข้อผิดพลาด');
        }
    })
    .catch(err => {
        console.error(err);
        alert('เกิดข้อผิดพลาดในการรับงาน');
    });
}

function startTask(taskId) {
    const csrfToken = getCsrfToken();
    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
    
    fetch(`/api/farmer/task/${taskId}/start`, { 
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ csrf_token: csrfToken })
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'เกิดข้อผิดพลาด');
            }
        });
}

function updateProgress(taskId, delta) {
    const csrfToken = getCsrfToken();
    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
    
    fetch(`/api/farmer/task/${taskId}/progress`, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ delta: delta, csrf_token: csrfToken })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'เกิดข้อผิดพลาด');
        }
    });
}

// เก็บชื่อเดิมไว้เพื่อความเข้ากันได้
function addProgress(taskId, delta) {
    updateProgress(taskId, delta);
}

function addCustomProgress(taskId) {
    const amount = parseInt(document.getElementById('custom_amount').value);
    if (amount && amount !== 0) {
        updateProgress(taskId, amount);
    } else {
        alert('กรุณาใส่จำนวนที่ถูกต้อง (ไม่เท่ากับ 0)');
    }
}

function pauseTask(taskId) {
    if (confirm('ต้องการพักงานนี้หรือไม่?')) {
        const csrfToken = getCsrfToken();
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
        
        fetch(`/api/farmer/task/${taskId}/pause`, { 
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ csrf_token: csrfToken })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'เกิดข้อผิดพลาด');
                }
            });
    }
}

function readyTask(taskId) {
    if (confirm('ยืนยันว่าพร้อมส่งของแล้ว?')) {
        const csrfToken = getCsrfToken();
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
        
        fetch(`/api/farmer/task/${taskId}/ready`, { 
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ csrf_token: csrfToken })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'เกิดข้อผิดพลาด');
                }
            });
    }
}

function deliveredTask(taskId) {
    if (confirm('ยืนยันว่าส่งของให้ลูกค้าเรียบร้อยแล้ว?')) {
        const csrfToken = getCsrfToken();
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
        
        fetch(`/api/farmer/task/${taskId}/delivered`, { 
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ csrf_token: csrfToken })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('บันทึกการส่งของเรียบร้อยแล้ว');
                    location.reload();
                } else {
                    alert(data.error || 'เกิดข้อผิดพลาด');
                }
            });
    }
}
</script>
{% endblock %}

