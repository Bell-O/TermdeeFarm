{% extends "base.html" %}

{% block title %}Leader Board - Termdee Farm{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title"><i class="fas fa-trophy"></i> Leader Board - อันดับคนฟาร์ม</h1>
    </div>

    <div class="mt-3">
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            ดูสถิติการฟาร์มของเพื่อนคนฟาร์มทั้งหมด ใครฟาร์มอะไรมากแค่ไหน รับมากี่งานแล้ว
        </p>

        {% if leaderboard %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 60px;" class="text-center">อันดับ</th>
                        <th>ชื่อคนฟาร์ม</th>
                        <th class="text-right">งานทั้งหมด</th>
                        <th class="text-right">งานเสร็จแล้ว</th>
                        <th class="text-right">กำลังทำ</th>
                        <th class="text-right">ยอดฟาร์มรวม</th>
                        <th class="text-center">อัตราเสร็จ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in leaderboard %}
                    <tr {% if loop.index <= 3 %}style="background: {% if loop.index == 1 %}#fff9e6{% elif loop.index == 2 %}#f0f0f0{% else %}#fff4e6{% endif %};"{% endif %}>
                        <td data-label="อันดับ" class="text-center">
                            {% if loop.index == 1 %}
                                <i class="fas fa-medal" style="color: #FFD700;"></i>
                            {% elif loop.index == 2 %}
                                <i class="fas fa-medal" style="color: #C0C0C0;"></i>
                            {% elif loop.index == 3 %}
                                <i class="fas fa-medal" style="color: #CD7F32;"></i>
                            {% else %}
                                <strong>#{{ loop.index }}</strong>
                            {% endif %}
                        </td>
                        <td data-label="ชื่อคนฟาร์ม">
                            <strong>{{ item.farmer.display_name or item.farmer.username }}</strong>
                            {% if not item.farmer.active %}
                            <span class="badge badge-canceled" style="margin-left: 0.5rem;">ปิดใช้งาน</span>
                            {% endif %}
                        </td>
                        <td data-label="งานทั้งหมด" class="text-right"><strong>{{ "{:,}".format(item.total_tasks) }}</strong></td>
                        <td data-label="งานเสร็จแล้ว" class="text-right"><span style="color: var(--success-color);"><strong>{{ "{:,}".format(item.completed_tasks) }}</strong></span></td>
                        <td data-label="กำลังทำ" class="text-right"><span style="color: var(--warning-color);"><strong>{{ "{:,}".format(item.active_tasks) }}</strong></span></td>
                        <td data-label="ยอดฟาร์มรวม" class="text-right">
                            <strong>{{ "{:,}".format(item.total_amount) }}</strong>
                            <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                                {% if item.item_breakdown %}
                                    {% for item_type, amount in item.item_breakdown.items() %}
                                        <span class="item-{{ item_type }}">{{ item_type|upper }}: {{ "{:,}".format(amount) }}</span>
                                        {% if not loop.last %} | {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </small>
                        </td>
                        <td data-label="อัตราเสร็จ" class="text-center">
                            {% if item.total_tasks > 0 %}
                                {% set completion_rate = (item.completed_tasks / item.total_tasks * 100) %}
                                <strong>{{ "%.1f"|format(completion_rate) }}%</strong>
                                <div class="progress" style="width: 100px; margin: 0.25rem auto 0;">
                                    <div class="progress-bar" style="width: {{ completion_rate }}%"></div>
                                </div>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center">ยังไม่มีข้อมูล</p>
        {% endif %}
    </div>

    <div class="mt-4">
        <h3><i class="fas fa-chart-bar"></i> สรุปสถิติ</h3>
        <div class="grid grid-3">
            <div class="card">
                <h4>คนฟาร์มทั้งหมด</h4>
                <p style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">
                    {{ leaderboard|length }}
                </p>
            </div>
            <div class="card">
                <h4>งานทั้งหมด</h4>
                <p style="font-size: 2rem; font-weight: bold; color: var(--success-color);">
                    {{ leaderboard|sum(attribute='total_tasks') if leaderboard else 0 }}
                </p>
            </div>
            <div class="card">
                <h4>ยอดฟาร์มรวม</h4>
                <p style="font-size: 2rem; font-weight: bold; color: var(--primary-color);">
                    {{ "{:,}".format(leaderboard|sum(attribute='total_amount') if leaderboard else 0) }}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}


