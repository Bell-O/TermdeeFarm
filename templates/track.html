{% extends "base.html" %}

{% block title %}‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå - Termdee Farm{% endblock %}

{% block container_class %}main-layout{% endblock %}

{% block content %}
<div class="content-wrapper">
<div class="card">
    <div class="card-header">
        <h1 class="card-title">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
    </div>

    <div class="card-body">
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        {% if not order %}
            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
            <form method="POST" action="{{ url_for('track_order') }}" class="mt-3">
                <div class="form-group">
                    <label class="form-label" for="order_key">Order Key</label>
                    <input type="text" id="order_key" name="order_key" 
                           class="form-control" 
                           placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Order Key (‡πÄ‡∏ä‡πà‡∏ô ABC123)" 
                           required 
                           style="text-transform: uppercase;">
                    <small style="color: var(--text-secondary);">
                        ‡πÉ‡∏™‡πà Order Key ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                    </small>
                </div>
                <button type="submit" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </form>
        {% else %}
            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå -->
            <div class="mt-3">
                <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: {{ order.order_key }}</h2>
                
                <div class="grid grid-2 mt-3">
                    <div>
                        <p><strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> {{ order.customer_ref or '-' }}</p>
                        <p><strong>‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå:</strong> {{ order.server_name or '-' }}</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> 
                            <span class="badge badge-{{ order.status }}">
                                {{ get_status_th(order.status) }}
                            </span>
                        </p>
                    </div>
                    <div>
                        <p><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        {% if queue_data %}
                        <p><strong>‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà:</strong> {{ queue_data.position }}</p>
                        <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> {{ queue_data.eta_display }}</p>
                        {% endif %}
                        {% if total_duration_hours and total_duration_hours > 0 %}
                        <p><strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ:</strong> 
                            {% if total_duration_hours >= 1 %}
                                {{ "%.1f"|format(total_duration_hours) }} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                            {% else %}
                                {{ (total_duration_hours * 60)|int }} ‡∏ô‡∏≤‡∏ó‡∏µ
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ -->
                <div class="mt-3" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                    <h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h3>
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß:</span>
                            <strong>{{ total_current|int }} / {{ total_target|int }}</strong>
                        </div>
                        <div class="progress-bar" style="width: 100%; height: 30px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            {% set progress = (total_current / total_target * 100) if total_target > 0 else 0 %}
                            <div style="width: {{ progress }}%; height: 100%; background: var(--primary-color); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                {{ "%.1f"|format(progress) }}%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Tasks -->
                {% if tasks %}
                <div class="mt-3">
                    <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th class="text-right">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                                    <th class="text-right">‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</th>
                                    <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏Ñ‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks %}
                                <tr>
                                    <td>
                                        <span class="item-{{ task.item_type }}">
                                            {{ task.item_type|upper }}
                                        </span>
                                    </td>
                                    <td data-label="‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢" class="text-right number">{{ "{:,}".format(task.target_amount|int) }}</td>
                                    <td data-label="‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß" class="text-right">
                                        <strong>{{ "{:,}".format(task.current_amount|int) }}</strong>
                                        {% if task.target_amount > 0 %}
                                            <br><small style="color: var(--text-secondary);">({{ "%.1f"|format((task.current_amount / task.target_amount * 100)) }}%)</small>
                                        {% endif %}
                                    </td>
                                    <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" class="text-center">
                                        <span class="badge badge-{{ task.status }}">
                                            {{ get_status_th(task.status) }}
                                        </span>
                                    </td>
                                    <td data-label="‡∏Ñ‡∏ô‡∏ü‡∏≤‡∏£‡πå‡∏°">{{ task.farmer.display_name if task.farmer else '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <div class="mt-3">
                    <a href="{{ url_for('track_order') }}" class="btn btn-secondary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô</a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
</div>

<!-- Sidebar Advertisement - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
<aside class="sidebar-ad featured-ad">
    <div class="ad-card meemeaw-ad">
        <div class="ad-badge"><i class="fas fa-star"></i> ‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
        <div class="ad-header">
            <img src="https://meemeaw.github.io/MeeMeaw/logo.png" alt="MeeMeaw" class="ad-logo-small">
            <span class="ad-brand">MeeMeaw</span>
        </div>
        <div class="ad-content">
            <p class="ad-text-main">‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡∏° MeeMeaw</p>
            <p class="ad-subtitle">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</p>
            <a href="https://meemeaw.github.io/MeeMeaw/" target="_blank" rel="noopener noreferrer" class="ad-button">
                üöÄ ‡∏î‡∏π‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
            </a>
        </div>
    </div>
</aside>

<style>
.progress-bar {
    position: relative;
}
</style>
{% endblock %}

